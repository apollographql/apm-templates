{"title":"RR-68: Query Planning Metrics","description":"[[suggested_dashboards]]","widgets":[{"id":1355103844861603,"definition":{"title":"Query Planning","background_color":"white","show_title":true,"type":"group","layout_type":"ordered","widgets":[{"id":942676723835878,"definition":{"type":"note","content":"The query planner is the heart of the runtime's computational efforts. This is where a request to your supergraph is translated into an invocation plan for the appropriate underlying subgraphs. Its performance will be very closely correlated to your supergraph schema and request characteristics, and will be the other determining factor in your response times beyond the subgraphs themselves.","background_color":"white","font_size":"14","text_align":"left","vertical_align":"top","show_tick":false,"tick_pos":"50%","tick_edge":"left","has_padding":true},"layout":{"x":0,"y":0,"width":12,"height":1}},{"id":7301212877184944,"definition":{"title":"Compute Job Avg Duration and Wait Time","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"time":{},"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"avg:apollo.router.compute_jobs.queue.wait.duration{service:$service.value,env:$env.value,version:$version.value} by {job.type}"},{"data_source":"metrics","name":"query2","query":"avg:apollo.router.compute_jobs.execution.duration{service:$service.value,env:$env.value,version:$version.value} by {job.type}"}],"formulas":[{"number_format":{"unit":{"type":"canonical_unit","unit_name":"second"}},"alias":"avg wait duration","formula":"query1"},{"number_format":{"unit":{"type":"canonical_unit","unit_name":"second"}},"alias":"avg execution duration","formula":"query2"}],"style":{"palette":"dog_classic","order_by":"tags","line_type":"solid","line_width":"normal"},"display_type":"line"},{"formulas":[{"alias":"schema reload","formula":"query1"}],"queries":[{"data_source":"metrics","name":"query1","query":"sum:apollo.router.schema.load.duration.count{service:$service.value,env:$env.value,version:$version.value}.as_count()"}],"response_format":"timeseries","style":{"palette":"gray","line_type":"solid","line_width":"normal"},"display_type":"overlay"},{"formulas":[{"alias":"cache warmup","formula":"query1"}],"queries":[{"data_source":"metrics","name":"query1","query":"sum:apollo.router.query_planning.warmup.duration.count{service:$service.value,env:$env.value,version:$version.value}.as_count()"}],"response_format":"timeseries","style":{"palette":"gray","line_type":"solid","line_width":"normal"},"display_type":"overlay"}],"yaxis":{"include_zero":true,"scale":"sqrt"}},"layout":{"x":0,"y":1,"width":5,"height":4}},{"id":7160674322835385,"definition":{"title":"Compute Job Max Duration","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query2","query":"max:apollo.router.compute_jobs.execution.duration{service:$service.value,env:$env.value,version:$version.value} by {job.type}"}],"formulas":[{"number_format":{"unit":{"type":"canonical_unit","unit_name":"second"}},"alias":"max execution duration","formula":"query2"}],"style":{"palette":"dog_classic","order_by":"tags","line_type":"solid","line_width":"normal"},"display_type":"line"}],"yaxis":{"include_zero":true,"scale":"sqrt"}},"layout":{"x":5,"y":1,"width":4,"height":4}},{"id":2646683015980845,"definition":{"title":"Queued Compute Jobs","title_size":"16","title_align":"left","show_legend":false,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"max:apollo.router.compute_jobs.queued{service:$service.value,env:$env.value,version:$version.value}"}],"formulas":[{"formula":"query1"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"},{"formulas":[{"alias":"schema reload","formula":"query1"}],"queries":[{"data_source":"metrics","name":"query1","query":"sum:apollo.router.schema.load.duration.count{service:$service.value,env:$env.value,version:$version.value}.as_count()"}],"response_format":"timeseries","style":{"palette":"gray","line_type":"solid","line_width":"normal"},"display_type":"overlay"}]},"layout":{"x":9,"y":1,"width":3,"height":4}},{"id":8368245832144593,"definition":{"type":"note","content":"This graph contains both the average wait and execution duration for all compute job types. This can help you detect if schema changes, config changes, or deployments have impacted the runtime's ability to plan queries for your supergraph.","background_color":"yellow","font_size":"14","text_align":"left","vertical_align":"center","show_tick":true,"tick_pos":"50%","tick_edge":"top","has_padding":true},"layout":{"x":0,"y":5,"width":5,"height":2}},{"id":5645196489907085,"definition":{"type":"note","content":"The maximum duration of your compute jobs can highlight if outlier queries are causing abnormal behavior in the query planner.","background_color":"yellow","font_size":"14","text_align":"left","vertical_align":"center","show_tick":true,"tick_pos":"50%","tick_edge":"top","has_padding":true},"layout":{"x":5,"y":5,"width":4,"height":2}},{"id":5923077997925504,"definition":{"type":"note","content":"A non-zero queue of compute jobs means that your runtime is backing up on work and will exhibit increased latency on any requests that are waiting on those jobs. This is generally an indication of insufficient CPU resources being allocated to handle your traffic.","background_color":"yellow","font_size":"14","text_align":"left","vertical_align":"center","show_tick":true,"tick_pos":"50%","tick_edge":"top","has_padding":true},"layout":{"x":9,"y":5,"width":3,"height":2}}]},"layout":{"x":0,"y":0,"width":12,"height":8}}],"template_variables":[{"name":"service","prefix":"service","available_values":[],"default":"router"},{"name":"env","prefix":"env","available_values":[],"default":"prod"},{"name":"version","prefix":"version","available_values":[],"default":"*"}],"layout_type":"ordered","notify_list":[],"reflow_type":"fixed","tags":["team:runtime-readiness"]}