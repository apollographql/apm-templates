{
  "title": "RR-88: Cache Metrics",
  "description": null,
  "widgets": [
    {
      "id": 1015408870961857,
      "definition": {
        "title": "Cache",
        "background_color": "white",
        "show_title": true,
        "type": "group",
        "layout_type": "ordered",
        "widgets": [
          {
            "id": 2338005724257191,
            "definition": {
              "type": "note",
              "content": "Monitoring your caching provides insights into both how normal your traffic is and how well your router is able to serve those requests. Your ideal cache performance and hit rates will vary depending on your expected traffic patterns. With the in-memory cache, it will be common to see spikes of cache misses and changes in cache size when new instances are deployed, new schemas are deployed, or new config versions are deployed. During this time, the cache will be evicted and re-warmed up.\n\nThese charts are pre-populated with event overlays for schema reloads and query plan warmup events. Schema reloads will accompany an expected drop in cache record count and a spike in cache miss rate as unusable cache records are evicted. [Cache warmups](https://www.apollographql.com/docs/graphos/routing/performance/caching/in-memory#cache-warm-up) will accompany a period of cache misses as new plans are deliberately hit to prime them into the cache. The router does not serve traffic on the new schema until after that precompute warmup has completed.\n\nFor context on whatâ€™s cached and why, review the in-memory caching  [documentation](https://www.apollographql.com/docs/graphos/routing/performance/caching/in-memory) before interpreting the charts below.\n\n**Caveats**\n- These metrics assume that you are running an in-memory cache on your Router. \n\n- If you are using Redis for distributed caching, you will want to monitor that separately [via Datadog's agent](https://docs.datadoghq.com/integrations/redisdb/?tab=host).\n\n- If you are using Entity Caching, [separate metrics will be available](https://www.apollographql.com/docs/graphos/routing/performance/caching/entity#observability) to monitor the performance of that feature.\n\n",
              "background_color": "white",
              "font_size": "14",
              "text_align": "left",
              "vertical_align": "top",
              "show_tick": false,
              "tick_pos": "50%",
              "tick_edge": "left",
              "has_padding": true
            },
            "layout": {
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 4
            }
          },
          {
            "id": 280811115102223,
            "definition": {
              "title": "Misses vs. Record Count",
              "title_size": "16",
              "title_align": "left",
              "show_legend": true,
              "legend_layout": "auto",
              "legend_columns": [
                "avg",
                "min",
                "max",
                "value",
                "sum"
              ],
              "time": {},
              "type": "timeseries",
              "requests": [
                {
                  "response_format": "timeseries",
                  "queries": [
                    {
                      "name": "query1",
                      "data_source": "metrics",
                      "query": "sum:apollo.router.cache.miss.time.count{service:$service.value,env:$env.value,version:$version.value}.as_count()"
                    }
                  ],
                  "formulas": [
                    {
                      "alias": "cache misses",
                      "formula": "query1"
                    }
                  ],
                  "style": {
                    "palette": "dog_classic",
                    "order_by": "values",
                    "line_type": "solid",
                    "line_width": "normal"
                  },
                  "display_type": "bars"
                },
                {
                  "on_right_yaxis": true,
                  "response_format": "timeseries",
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query0",
                      "query": "avg:apollo.router.cache.size{service:$service.value,env:$env.value,version:$version.value}"
                    }
                  ],
                  "formulas": [
                    {
                      "alias": "cache record count",
                      "formula": "query0"
                    }
                  ],
                  "style": {
                    "palette": "dog_classic",
                    "line_type": "solid",
                    "line_width": "normal"
                  },
                  "display_type": "line"
                },
                {
                  "on_right_yaxis": true,
                  "response_format": "timeseries",
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query0",
                      "query": "sum:apollo.router.cache.hit.time.count{service:$service.value,env:$env.value,version:$version.value}.as_count()"
                    },
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "sum:apollo.router.cache.miss.time.count{service:$service.value,env:$env.value,version:$version.value}.as_count()"
                    }
                  ],
                  "formulas": [
                    {
                      "alias": "cache hit %",
                      "formula": "(query0 / (query0 + query1)) * 100"
                    }
                  ],
                  "style": {
                    "palette": "dog_classic",
                    "line_type": "solid",
                    "line_width": "normal"
                  },
                  "display_type": "line"
                },
                {
                  "formulas": [
                    {
                      "alias": "cache warmup",
                      "formula": "query1"
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "sum:apollo.router.query_planning.warmup.duration.count{service:$service.value,env:$env.value,version:$version.value}.as_count()"
                    }
                  ],
                  "response_format": "timeseries",
                  "style": {
                    "palette": "gray",
                    "line_type": "solid",
                    "line_width": "normal"
                  },
                  "display_type": "overlay"
                },
                {
                  "formulas": [
                    {
                      "alias": "schema reload",
                      "formula": "query1"
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "sum:apollo.router.schema.load.duration.count{service:$service.value,env:$env.value,version:$version.value}.as_count()"
                    }
                  ],
                  "response_format": "timeseries",
                  "style": {
                    "palette": "gray",
                    "line_type": "solid",
                    "line_width": "normal"
                  },
                  "display_type": "overlay"
                }
              ],
              "yaxis": {
                "include_zero": true
              },
              "right_yaxis": {
                "include_zero": false,
                "scale": "log"
              }
            },
            "layout": {
              "x": 0,
              "y": 4,
              "width": 6,
              "height": 4
            }
          },
          {
            "id": 5973444432338869,
            "definition": {
              "title": "Record Counts by Instance",
              "title_size": "16",
              "title_align": "left",
              "show_legend": false,
              "legend_layout": "auto",
              "legend_columns": [
                "avg",
                "min",
                "max",
                "value",
                "sum"
              ],
              "time": {},
              "type": "timeseries",
              "requests": [
                {
                  "response_format": "timeseries",
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "avg:apollo.router.cache.size{service:$service.value,env:$env.value,version:$version.value} by {instance-id}"
                    }
                  ],
                  "formulas": [
                    {
                      "formula": "query1"
                    }
                  ],
                  "style": {
                    "palette": "dog_classic",
                    "order_by": "tags",
                    "line_type": "solid",
                    "line_width": "normal"
                  },
                  "display_type": "line"
                },
                {
                  "formulas": [
                    {
                      "alias": "cache warmup",
                      "formula": "query1"
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "sum:apollo.router.query_planning.warmup.duration.count{service:$service.value,env:$env.value,version:$version.value}.as_count()"
                    }
                  ],
                  "response_format": "timeseries",
                  "style": {
                    "palette": "gray",
                    "line_type": "solid",
                    "line_width": "normal"
                  },
                  "display_type": "overlay"
                },
                {
                  "formulas": [
                    {
                      "alias": "schema reload",
                      "formula": "query1"
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "sum:apollo.router.schema.load.duration.count{service:$service.value,env:$env.value,version:$version.value}.as_count()"
                    }
                  ],
                  "response_format": "timeseries",
                  "style": {
                    "palette": "gray",
                    "line_type": "solid",
                    "line_width": "normal"
                  },
                  "display_type": "overlay"
                }
              ]
            },
            "layout": {
              "x": 6,
              "y": 4,
              "width": 6,
              "height": 4
            }
          },
          {
            "id": 3045863848046569,
            "definition": {
              "type": "note",
              "content": "This chart shows an aggregate view across all cache types of your record counts and how many cache misses are happening. This is a lower-cardinality aggregate view of all the other charts in this section, specifically for correlating events between them.\n\n**Why it matters:**\n\n* Your cache sizes impact the memory footprint of your runtime\n* Your cache miss counts represent costlier requests to your runtime\n\n**What to look for:**\n* Drops in record counts that are *not* correlated to schema reloads or new instance deployments\n* Spikes in cache misses that are *not* correlated to a drop in record count\n* Spikes in cache misses that *do* correlate to a significant drop in cache hit percentage",
              "background_color": "yellow",
              "font_size": "14",
              "text_align": "left",
              "vertical_align": "center",
              "show_tick": true,
              "tick_pos": "50%",
              "tick_edge": "top",
              "has_padding": true
            },
            "layout": {
              "x": 0,
              "y": 8,
              "width": 6,
              "height": 1
            }
          },
          {
            "id": 4941765757767393,
            "definition": {
              "type": "note",
              "content": "This chart breaks down the number of records in the cache of each of your runtime instances.\n\n**Why it matters:**\n\n* If your traffic isn't well-distributed across your instances, some caches will lag behind in growth rate\n* If you have an instance go into an unhealthy state, you may see the anomaly represented here\n\n**What to look for:**\n* An instance or instances that have an anomalous count of records without a corresponding deployment or schema change\n* An instance or instances that are growing at a different rate than the others without a corresponding deployment",
              "background_color": "yellow",
              "font_size": "14",
              "text_align": "left",
              "vertical_align": "center",
              "show_tick": true,
              "tick_pos": "50%",
              "tick_edge": "top",
              "has_padding": true
            },
            "layout": {
              "x": 6,
              "y": 8,
              "width": 6,
              "height": 1
            }
          },
          {
            "id": 8120174499044240,
            "definition": {
              "title": "Record Counts by Type",
              "title_size": "16",
              "title_align": "left",
              "show_legend": false,
              "legend_layout": "auto",
              "legend_columns": [
                "avg",
                "min",
                "max",
                "value",
                "sum"
              ],
              "time": {},
              "type": "timeseries",
              "requests": [
                {
                  "response_format": "timeseries",
                  "queries": [
                    {
                      "name": "query1",
                      "data_source": "metrics",
                      "query": "sum:apollo.router.cache.size{service:$service.value,env:$env.value,version:$version.value} by {kind,version}"
                    }
                  ],
                  "formulas": [
                    {
                      "alias": "cache record count",
                      "formula": "query1"
                    }
                  ],
                  "style": {
                    "palette": "dog_classic",
                    "order_by": "values",
                    "line_type": "solid",
                    "line_width": "normal"
                  },
                  "display_type": "line"
                }
              ],
              "yaxis": {
                "include_zero": false,
                "scale": "log"
              }
            },
            "layout": {
              "x": 0,
              "y": 9,
              "width": 4,
              "height": 3
            }
          },
          {
            "id": 8691777953686757,
            "definition": {
              "title": "Misses by Type",
              "title_size": "16",
              "title_align": "left",
              "show_legend": false,
              "legend_layout": "auto",
              "legend_columns": [
                "avg",
                "min",
                "max",
                "value",
                "sum"
              ],
              "time": {},
              "type": "timeseries",
              "requests": [
                {
                  "response_format": "timeseries",
                  "queries": [
                    {
                      "name": "query1",
                      "data_source": "metrics",
                      "query": "sum:apollo.router.cache.miss.time.count{service:$service.value,env:$env.value,version:$version.value} by {kind,version}.as_count()"
                    }
                  ],
                  "formulas": [
                    {
                      "alias": "cache misses",
                      "formula": "query1"
                    }
                  ],
                  "style": {
                    "palette": "dog_classic",
                    "order_by": "values",
                    "line_type": "solid",
                    "line_width": "thick"
                  },
                  "display_type": "bars"
                }
              ],
              "yaxis": {
                "include_zero": true,
                "scale": "linear"
              }
            },
            "layout": {
              "x": 4,
              "y": 9,
              "width": 4,
              "height": 3
            }
          },
          {
            "id": 7905054550039923,
            "definition": {
              "title": "Hit % by Instance",
              "title_size": "16",
              "title_align": "left",
              "show_legend": false,
              "legend_layout": "auto",
              "legend_columns": [
                "avg",
                "min",
                "max",
                "value",
                "sum"
              ],
              "time": {},
              "type": "timeseries",
              "requests": [
                {
                  "response_format": "timeseries",
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query0",
                      "query": "sum:apollo.router.cache.hit.time.count{service:$service.value,env:$env.value,version:$version.value} by {instance-id}.as_count()"
                    },
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "sum:apollo.router.cache.miss.time.count{service:$service.value,env:$env.value,version:$version.value} by {instance-id}.as_count()"
                    }
                  ],
                  "formulas": [
                    {
                      "alias": "cache hit %",
                      "formula": "(query0 / (query0 + query1)) * 100"
                    }
                  ],
                  "style": {
                    "palette": "dog_classic",
                    "order_by": "tags",
                    "line_type": "solid",
                    "line_width": "normal"
                  },
                  "display_type": "line"
                }
              ],
              "yaxis": {
                "include_zero": true,
                "scale": "pow",
                "min": "auto",
                "max": "105"
              },
              "markers": []
            },
            "layout": {
              "x": 8,
              "y": 9,
              "width": 4,
              "height": 3
            }
          },
          {
            "id": 7314147141979253,
            "definition": {
              "type": "note",
              "content": "This chart shows cache record counts broken down by each cache type.\n\n**Why it matters:**\n\n* When diagnosing issues with the above aggregate values, it can be informational to see the breakdown at a finer level of detail",
              "background_color": "yellow",
              "font_size": "14",
              "text_align": "left",
              "vertical_align": "center",
              "show_tick": true,
              "tick_pos": "50%",
              "tick_edge": "top",
              "has_padding": true
            },
            "layout": {
              "x": 0,
              "y": 12,
              "width": 4,
              "height": 1
            }
          },
          {
            "id": 5420652058492445,
            "definition": {
              "type": "note",
              "content": "This chart shows cache misses broken down by cache type.\n\n**Why it matters:**\n\n* When diagnosing issues with the above aggregate values, it can be informational to see the breakdown at a finer level of detail",
              "background_color": "yellow",
              "font_size": "14",
              "text_align": "left",
              "vertical_align": "center",
              "show_tick": true,
              "tick_pos": "50%",
              "tick_edge": "top",
              "has_padding": true
            },
            "layout": {
              "x": 4,
              "y": 12,
              "width": 4,
              "height": 1
            }
          },
          {
            "id": 2128081234153598,
            "definition": {
              "type": "note",
              "content": "This chart shows cache hit rate broken down by each individual running instance of your runtime.\n\n**Why it matters:**\n\n* When diagnosing issues with the above aggregate values, it can be informational to see the breakdown at a finer level of detail",
              "background_color": "yellow",
              "font_size": "14",
              "text_align": "left",
              "vertical_align": "center",
              "show_tick": true,
              "tick_pos": "50%",
              "tick_edge": "top",
              "has_padding": true
            },
            "layout": {
              "x": 8,
              "y": 12,
              "width": 4,
              "height": 1
            }
          }
        ]
      },
      "layout": {
        "x": 0,
        "y": 0,
        "width": 12,
        "height": 14
      }
    }
  ],
  "template_variables": [
    {
      "name": "service",
      "prefix": "service",
      "available_values": [],
      "default": "router"
    },
    {
      "name": "env",
      "prefix": "env",
      "available_values": [],
      "default": "prod"
    },
    {
      "name": "version",
      "prefix": "version",
      "available_values": [],
      "default": "*"
    }
  ],
  "layout_type": "ordered",
  "notify_list": [],
  "reflow_type": "fixed",
  "tags": [
    "team:runtime-readiness"
  ]
}
