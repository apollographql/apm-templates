{"title":"RR-67: Container/Host Metrics","description":null,"widgets":[{"id":5629804781331548,"definition":{"title":"Container/Host","background_color":"white","show_title":true,"type":"group","layout_type":"ordered","widgets":[{"id":1060056504123377,"definition":{"type":"note","content":"Monitoring the resource consumption of your execution environment is essential to ensuring that your runtime can perform as desired.\n\nWe recommend monitoring for and ensuring that your average CPU usage does not exceed 80% load, to leave available overhead for expensive spikes such as schema reloads.\n\nYou can use the [router resource estimator](https://www.apollographql.com/docs/graphos/routing/self-hosted/resource-estimator) to determine what your memory thresholds and allocations should be.\n\nBelow are some example charts of how to plot this data in various deployment environments. They are parameterized using Datadog's [unified service tagging](https://docs.datadoghq.com/getting_started/tagging/unified_service_tagging).","background_color":"white","font_size":"14","text_align":"left","vertical_align":"top","show_tick":false,"tick_pos":"50%","tick_edge":"left","has_padding":true},"layout":{"x":0,"y":0,"width":12,"height":2}},{"id":7198505991257678,"definition":{"title":"Kubernetes CPU Usage","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"name":"query1","data_source":"metrics","query":"avg:kubernetes.cpu.usage.total{service:$service.value ,env:$env.value ,version:$version.value}"},{"name":"query2","data_source":"metrics","query":"max:kubernetes.cpu.usage.total{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"number_format":{},"alias":"avg CPU","formula":"query1"},{"number_format":{},"alias":"max CPU","formula":"query2"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"},{"on_right_yaxis":false,"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query0","query":"max:kubernetes.cpu.limits{service:$service.value ,env:$env.value ,version:$version.value}"},{"data_source":"metrics","name":"query1","query":"min:kubernetes.cpu.limits{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"number_format":{},"style":{"palette":"warm","palette_index":0},"alias":"max cpu limit","formula":"query0"},{"number_format":{},"style":{"palette":"warm","palette_index":0},"alias":"min cpu limit","formula":"query1"}],"style":{"palette":"red","order_reverse":false,"line_type":"dashed","line_width":"thin"},"display_type":"line"}],"yaxis":{"include_zero":true,"scale":"linear","max":"auto"},"markers":[]},"layout":{"x":0,"y":2,"width":3,"height":3}},{"id":4808663335885167,"definition":{"title":"Host CPU Usage (OTEL Collector - Hostmetrics)","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"name":"query2","data_source":"metrics","query":"avg:system.cpu.stolen{service:$service.value ,env:$env.value ,version:$version.value}"},{"name":"query1","data_source":"metrics","query":"avg:system.cpu.iowait{service:$service.value ,env:$env.value ,version:$version.value}"},{"name":"query3","data_source":"metrics","query":"avg:system.cpu.system{service:$service.value ,env:$env.value ,version:$version.value}"},{"name":"query4","data_source":"metrics","query":"avg:system.cpu.user{service:$service.value ,env:$env.value ,version:$version.value}"},{"name":"query5","data_source":"metrics","query":"avg:system.cpu.idle{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"number_format":{},"style":{"palette":"classic","palette_index":4},"alias":"avg stolen","formula":"query2"},{"number_format":{},"style":{"palette":"classic","palette_index":5},"alias":"avg iowait","formula":"query1"},{"number_format":{},"style":{"palette":"classic","palette_index":1},"alias":"avg system","formula":"query3"},{"number_format":{},"style":{"palette":"classic","palette_index":2},"alias":"avg user","formula":"query4"},{"number_format":{},"style":{"palette":"classic","palette_index":0},"alias":"avg idle","formula":"query5"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"area"}],"yaxis":{"include_zero":true,"scale":"linear","min":"0","max":"100"},"markers":[{"label":" Example Threshold ","value":"y = 75","display_type":"error dashed"}]},"layout":{"x":3,"y":2,"width":3,"height":3}},{"id":3871424817397328,"definition":{"title":"Docker CPU Usage (Datadog Docker Agent)","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"name":"query3","data_source":"metrics","query":"avg:docker.cpu.usage{service:$service.value ,env:$env.value ,version:$version.value}"},{"name":"query1","data_source":"metrics","query":"max:docker.cpu.usage{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"number_format":{},"style":{"palette":"classic","palette_index":1},"alias":"avg cpu","formula":"query3"},{"number_format":{},"style":{"palette":"classic","palette_index":1},"alias":"max cpu","formula":"query1"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"area"},{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query0","query":"avg:docker.cpu.limit{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"alias":"cpu limit","formula":"query0"}],"style":{"palette":"red","line_type":"dashed","line_width":"thin"},"display_type":"line"}],"yaxis":{"include_zero":false,"scale":"linear","min":"auto","max":"auto"},"markers":[]},"layout":{"x":6,"y":2,"width":3,"height":3}},{"id":7178237105285863,"definition":{"title":"Docker CPU Usage (OTEL Collector  - Docker/stats)","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"name":"query1","data_source":"metrics","query":"avg:container.cpu.usage.total{service:$service.value ,env:$env.value ,version:$version.value}"},{"name":"query2","data_source":"metrics","query":"max:container.cpu.usage.total{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"number_format":{},"alias":"avg cpu","formula":"query1"},{"number_format":{},"alias":"max cpu","formula":"query2"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"},{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query0","query":"min:container.cpu.limit{service:$service.value ,env:$env.value ,version:$version.value}"},{"data_source":"metrics","name":"query1","query":"max:container.cpu.limit{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"alias":"min cpu limit","style":{"palette":"warm","palette_index":0},"formula":"query0"},{"alias":"max cpu limit","style":{"palette":"warm","palette_index":0},"formula":"query1"}],"style":{"palette":"red","color_order":"monotonic","line_type":"dashed","line_width":"thin"},"display_type":"line"}],"yaxis":{"include_zero":true,"scale":"linear","max":"auto"},"markers":[]},"layout":{"x":9,"y":2,"width":3,"height":3}},{"id":1123646347411335,"definition":{"title":"Kubernetes Memory Usage","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"name":"query1","data_source":"metrics","query":"avg:kubernetes.memory.usage{service:$service.value ,env:$env.value ,version:$version.value}"},{"name":"query2","data_source":"metrics","query":"max:kubernetes.memory.usage{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"number_format":{},"alias":"average memory","formula":"query1"},{"number_format":{},"alias":"max memory","formula":"query2"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"},{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query0","query":"min:kubernetes.memory.limits{service:$service.value ,env:$env.value ,version:$version.value}"},{"data_source":"metrics","name":"query1","query":"max:kubernetes.memory.limits{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"style":{"palette":"warm","palette_index":0},"alias":"min memory limit","formula":"query0"},{"style":{"palette":"warm","palette_index":0},"alias":"max memory limit","formula":"query1"}],"style":{"palette":"red","line_type":"dashed","line_width":"thin"},"display_type":"line"}],"markers":[]},"layout":{"x":0,"y":5,"width":3,"height":3}},{"id":7061503711231094,"definition":{"title":"Host Memory Usage (OTEL Collector - Hostmetrics)","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"name":"query1","data_source":"metrics","query":"avg:system.mem.used{service:$service.value ,env:$env.value ,version:$version.value}"},{"name":"query2","data_source":"metrics","query":"max:system.mem.used{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"number_format":{},"alias":"average memory","formula":"query1"},{"number_format":{},"alias":"max memory","formula":"query2"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"},{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query0","query":"min:system.mem.total{service:$service.value ,env:$env.value ,version:$version.value}"},{"data_source":"metrics","name":"query1","query":"max:system.mem.total{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"alias":"min available memory","formula":"query0"},{"alias":"max available memory","formula":"query1"}],"style":{"palette":"dog_classic","line_type":"solid","line_width":"normal"},"display_type":"line"}],"markers":[{"label":" Example Host Limit ","value":"y = 150000000000","display_type":"error dashed"}]},"layout":{"x":3,"y":5,"width":3,"height":3}},{"id":3525357882872541,"definition":{"title":"Docker Memory Usage (Datadog Docker Agent)","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"name":"query1","data_source":"metrics","query":"avg:docker.mem.in_use{service:$service.value ,env:$env.value ,version:$version.value}"},{"name":"query2","data_source":"metrics","query":"max:docker.mem.in_use{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"number_format":{},"alias":"average memory","formula":"query1"},{"number_format":{},"alias":"max memory","formula":"query2"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"},{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query0","query":"avg:docker.mem.limit{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"alias":"memory limit","formula":"query0"}],"style":{"palette":"red","line_type":"dashed","line_width":"thin"},"display_type":"line"}],"markers":[]},"layout":{"x":6,"y":5,"width":3,"height":3}},{"id":6913818230766855,"definition":{"title":"Docker Memory Usage (OTEL Collector  - Docker/stats)","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"name":"query1","data_source":"metrics","query":"avg:container.memory.usage.total{service:$service.value ,env:$env.value ,version:$version.value}"},{"name":"query2","data_source":"metrics","query":"max:container.memory.usage.total{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"number_format":{},"alias":"average memory","formula":"query1"},{"number_format":{},"alias":"max memory","formula":"query2"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"},{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query0","query":"avg:container.memory.usage.limit{service:$service.value ,env:$env.value ,version:$version.value}"}],"formulas":[{"alias":"memory limit","formula":"query0"}],"style":{"palette":"red","line_type":"dashed","line_width":"thin"},"display_type":"line"}],"markers":[]},"layout":{"x":9,"y":5,"width":3,"height":3}},{"id":7008282361541690,"definition":{"type":"note","content":"These charts draw their threshold marker dynamically based on the limits specified in Kubernetes for memory and CPU. If your runtime is deployed across heterogeneous container configurations for those values, the dynamic thresholds will display both the min and the max values.\n\nFor more details on available Kubernetes metrics, see the full [documentation on the Datadog Kubernetes collector](https://docs.datadoghq.com/containers/kubernetes/data_collected/).","background_color":"yellow","font_size":"14","text_align":"left","vertical_align":"top","show_tick":true,"tick_pos":"50%","tick_edge":"top","has_padding":true},"layout":{"x":0,"y":8,"width":3,"height":4}},{"id":2580801244854878,"definition":{"type":"note","content":"The memory chart draws its threshold marker dynamically based on the available memory on your hosts. If your runtime is deployed across heterogeneous hosts, the threshold will display both the min and the max values.\n\nFor more details on available host metrics, see datadog's [documentation on the OTEL collectors hostmetrics reciever](https://docs.datadoghq.com/opentelemetry/integrations/host_metrics/?tab=host).","background_color":"yellow","font_size":"14","text_align":"left","vertical_align":"top","show_tick":true,"tick_pos":"50%","tick_edge":"top","has_padding":true},"layout":{"x":3,"y":8,"width":3,"height":4}},{"id":7978212210408136,"definition":{"type":"note","content":"These charts draw their threshold marker dynamically based on the limits specified in Docker for memory and CPU. If your runtime is deployed across heterogeneous container configurations for those values, the threshold will display both the min and the max values.\n\nFor more details on available Docker metrics via the Datadog Docker Agent, see the full [documentation on the Datadog Docker Agent](https://docs.datadoghq.com/containers/docker).","background_color":"yellow","font_size":"14","text_align":"left","vertical_align":"top","show_tick":true,"tick_pos":"50%","tick_edge":"top","has_padding":true},"layout":{"x":6,"y":8,"width":3,"height":4}},{"id":548917227211873,"definition":{"type":"note","content":"These charts draw their threshold marker dynamically based on the limits specified in Docker for memory and CPU. If your runtime is deployed across heterogeneous container configurations for those values, the threshold will display both the min and the max values.\n\nFor more details on available Docker metrics via the OTEL collector, see Datadog's [documentation on the OTEL collector Docker/stats receiver](https://docs.datadoghq.com/opentelemetry/integrations/docker_metrics).","background_color":"yellow","font_size":"14","text_align":"left","vertical_align":"top","show_tick":true,"tick_pos":"50%","tick_edge":"top","has_padding":true},"layout":{"x":9,"y":8,"width":3,"height":4}}]},"layout":{"x":0,"y":0,"width":12,"height":13}}],"template_variables":[{"name":"service","prefix":"service","available_values":[],"default":"router"},{"name":"env","prefix":"env","available_values":["prod","staging","dev"],"default":"prod"},{"name":"version","prefix":"version","available_values":[],"default":"*"}],"layout_type":"ordered","notify_list":[],"reflow_type":"fixed","tags":["team:runtime-readiness"]}