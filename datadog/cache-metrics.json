{"title":"RR-88: Cache Metrics","description":null,"widgets":[{"id":1015408870961857,"definition":{"title":"Cache","background_color":"white","show_title":true,"type":"group","layout_type":"ordered","widgets":[{"id":2338005724257191,"definition":{"type":"note","content":"These metrics assume that you are running an in-memory cache [(see the documentation for details on what data is cached and why)](https://www.apollographql.com/docs/graphos/routing/performance/caching/in-memory) on your Router. If you are using Redis for distributed caching, you will want to monitor that separately [via Datadog's agent](https://docs.datadoghq.com/integrations/redisdb/?tab=host).\n\nIf you are using Entity Caching, [separate metrics will be available](https://www.apollographql.com/docs/graphos/routing/performance/caching/entity#observability) to monitor the performance of that feature.\n\nMonitoring your caching provides insights into both how normal your traffic is and how well your router is able to serve those requests. Your ideal cache performance and hit rates will vary depending on your expected traffic patterns. With the in-memory cache, it will be common to see spikes of cache misses and changes in cache size when new instances are deployed, new schemas are deployed, or new config versions are deployed. During this time, the cache will be evicted and re-warmed up. To make it clear when this is happening, we recommend configuring an [event overlay](https://docs.datadoghq.com/dashboards/widgets/timeseries/#event-overlay) on the charts that correlates to instance deployments.","background_color":"white","font_size":"14","text_align":"left","vertical_align":"top","show_tick":false,"tick_pos":"50%","tick_edge":"left","has_padding":true},"layout":{"x":0,"y":0,"width":12,"height":3}},{"id":280811115102223,"definition":{"title":"Cache Misses vs. Cache Record Count","title_size":"16","title_align":"left","show_legend":true,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"name":"query1","data_source":"metrics","query":"sum:apollo.router.cache.miss.time.count{service:$service.value,env:$env.value,version:$version.value}.as_count()"}],"formulas":[{"alias":"cache misses","formula":"query1"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"bars"},{"on_right_yaxis":true,"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query0","query":"avg:apollo.router.cache.size{service:$service.value,env:$env.value,version:$version.value}"}],"formulas":[{"alias":"cache record count","formula":"query0"}],"style":{"palette":"dog_classic","line_type":"solid","line_width":"normal"},"display_type":"line"},{"on_right_yaxis":true,"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query0","query":"sum:apollo.router.cache.hit.time.count{service:$service.value,env:$env.value,version:$version.value}.as_count()"},{"data_source":"metrics","name":"query1","query":"sum:apollo.router.cache.miss.time.count{service:$service.value,env:$env.value,version:$version.value}.as_count()"}],"formulas":[{"alias":"cache hit %","formula":"(query0 / (query0 + query1)) * 100"}],"style":{"palette":"dog_classic","line_type":"solid","line_width":"normal"},"display_type":"line"}],"yaxis":{"include_zero":true},"right_yaxis":{"include_zero":false,"scale":"log"}},"layout":{"x":0,"y":3,"width":6,"height":4}},{"id":5973444432338869,"definition":{"title":"Cache Record Counts by Instance","title_size":"16","title_align":"left","show_legend":false,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query1","query":"avg:apollo.router.cache.size{service:$service.value,env:$env.value,version:$version.value} by {instance-id}"}],"formulas":[{"formula":"query1"}],"style":{"palette":"dog_classic","order_by":"tags","line_type":"solid","line_width":"normal"},"display_type":"line"}]},"layout":{"x":6,"y":3,"width":6,"height":4}}]},"layout":{"x":0,"y":0,"width":12,"height":8}},{"id":8120174499044240,"definition":{"title":"Cache Record Counts by Cache Type","title_size":"16","title_align":"left","show_legend":false,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"name":"query1","data_source":"metrics","query":"sum:apollo.router.cache.size{service:$service.value,env:$env.value,version:$version.value} by {kind,version}"}],"formulas":[{"alias":"cache record count","formula":"query1"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"normal"},"display_type":"line"}],"yaxis":{"include_zero":false,"scale":"log"}},"layout":{"x":0,"y":0,"width":4,"height":3}},{"id":8691777953686757,"definition":{"title":"Cache Misses by Cache Type","title_size":"16","title_align":"left","show_legend":false,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"name":"query1","data_source":"metrics","query":"sum:apollo.router.cache.miss.time.count{service:$service.value,env:$env.value,version:$version.value} by {kind,version}.as_count()"}],"formulas":[{"alias":"cache misses","formula":"query1"}],"style":{"palette":"dog_classic","order_by":"values","line_type":"solid","line_width":"thick"},"display_type":"bars"}],"yaxis":{"include_zero":true,"scale":"linear"}},"layout":{"x":4,"y":0,"width":4,"height":3}},{"id":7905054550039923,"definition":{"title":"Cache Hit % by Instance","title_size":"16","title_align":"left","show_legend":false,"legend_layout":"auto","legend_columns":["avg","min","max","value","sum"],"type":"timeseries","requests":[{"response_format":"timeseries","queries":[{"data_source":"metrics","name":"query0","query":"sum:apollo.router.cache.hit.time.count{service:$service.value,env:$env.value,version:$version.value} by {instance-id}.as_count()"},{"data_source":"metrics","name":"query1","query":"sum:apollo.router.cache.miss.time.count{service:$service.value,env:$env.value,version:$version.value} by {instance-id}.as_count()"}],"formulas":[{"alias":"cache hit %","formula":"(query0 / (query0 + query1)) * 100"}],"style":{"palette":"dog_classic","order_by":"tags","line_type":"solid","line_width":"normal"},"display_type":"line"}],"yaxis":{"include_zero":true,"scale":"pow","min":"auto","max":"105"},"markers":[]},"layout":{"x":8,"y":0,"width":4,"height":3}}],"template_variables":[{"name":"service","prefix":"service","available_values":[],"default":"router"},{"name":"env","prefix":"env","available_values":[],"default":"prod"},{"name":"version","prefix":"version","available_values":[],"default":"*"}],"layout_type":"ordered","notify_list":[],"reflow_type":"fixed","tags":["team:runtime-readiness"]}